I"w˛<p><strong>Editor‚Äôs Note: This is mirrored from <a href="https://www.raywenderlich.com/180721/kitura-tutorial-getting-started-with-server-side-swift">RayWenderlich.com</a>, and it was my first ever post on his website!.</strong></p>

<p>Are you a busy Swift developer, with no time to learn Node.js, but still feeling drawn to server-side development? This Kitura tutorial will teach you how to create RESTful APIs written entirely in Swift.</p>

<p>You‚Äôll build a ‚ÄúToday I Learned‚Äù app to help you learn and remember common acronyms. Along the way, you‚Äôll learn how to:</p>

<ul>
  <li>Create a backend API from scratch.</li>
  <li>Link your API to a CouchDB instance running on your local machine.</li>
  <li>Assign GET, POST, and DELETE routes for a model object.</li>
</ul>

<h2 id="getting-started">Getting Started</h2>

<p>To complete this Kitura tutorial, you‚Äôll need:</p>

<ul>
  <li>macOS 10.12 (Sierra) or higher</li>
  <li>Xcode 9.2 or newer</li>
  <li>Basic familiarity with Terminal, as you‚Äôll use the command line quite a bit in this tutorial.</li>
</ul>

<p><strong>Note:</strong> It‚Äôs possible to use Kitura with simply a text editor and a standalone Swift installation, which makes it possible to run Kitura even on Linux! However, this tutorial uses Xcode to take advantage of autocomplete and the nuances of a familiar development environment.</p>

<h2 id="installing-couchdb">Installing CouchDB</h2>

<p>You‚Äôll use a database called <em><a href="http://couchdb.apache.org/" rel="noopener" target="_blank">CouchDB</a></em> in this Kitura tutorial. This is a NoSQL database that strictly enforces JSON and uses revision keys for updates. So it‚Äôs safe ‚Äî and fast!</p>

<p><a href="https://brew.sh/" rel="noopener" target="_blank"><em>Homebrew</em></a>, a popular package manager for macOS, is the easiest way to install CouchDB. If you don‚Äôt have Homebrew installed already, open Terminal and enter this command:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>/usr/bin/ruby <span class="nt">-e</span> <span class="s2">"</span><span class="si">$(</span>curl <span class="nt">-fsSL</span> https://raw.githubusercontent.com/Homebrew/install/master/install<span class="si">)</span><span class="s2">"</span>
</code></pre></div></div>

<p>Enter your password if prompted. You should see <em>Installation Successful</em> once it completes.</p>

<p>Next, enter this command to install CouchDB:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>brew <span class="nb">install </span>couchdb
</code></pre></div></div>

<p>Once it‚Äôs installed, enter this command to start CouchDB:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>brew services start couchdb
</code></pre></div></div>

<p>To confirm CouchDB installed and started successfully, open a web browser and navigate to <a href="http://localhost:5984" rel="noopener" target="_blank">http://localhost:5984</a>. You should see something like this:</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span>
  <span class="dl">"</span><span class="s2">couchdb</span><span class="dl">"</span><span class="p">:</span> <span class="dl">"</span><span class="s2">Welcome</span><span class="dl">"</span><span class="p">,</span>
  <span class="dl">"</span><span class="s2">uuid</span><span class="dl">"</span><span class="p">:</span> <span class="dl">"</span><span class="s2">29b2fe0fb4054c61e6b4b8e01761707b</span><span class="dl">"</span><span class="p">,</span>
  <span class="dl">"</span><span class="s2">version</span><span class="dl">"</span><span class="p">:</span> <span class="dl">"</span><span class="s2">1.7.1</span><span class="dl">"</span><span class="p">,</span>
  <span class="dl">"</span><span class="s2">vendor</span><span class="dl">"</span><span class="p">:</span> <span class="p">{</span>
      <span class="dl">"</span><span class="s2">name</span><span class="dl">"</span><span class="p">:</span> <span class="dl">"</span><span class="s2">Homebrew</span><span class="dl">"</span><span class="p">,</span>
      <span class="dl">"</span><span class="s2">version</span><span class="dl">"</span><span class="p">:</span> <span class="dl">"</span><span class="s2">1.7.1</span><span class="dl">"</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p><strong>Note:</strong> If you‚Äôd prefer not to install CouchDB directly and have Docker installed, you may run it in Docker using the command:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>docker run <span class="nt">--name</span> couchdb <span class="nt">-p</span> 5984:5984 <span class="nt">-d</span> couchdb
</code></pre></div></div>

<p>Before you can dive into this Kitura tutorial, you‚Äôll need to first understand a little about Kitura and REST.</p>

<h2 id="kitura--restful-api-routing">Kitura &amp; RESTful API Routing</h2>

<p>IBM created <em><a href="http://kitura.io" rel="noopener" target="_blank">Kitura</a></em> as an open-source framework in 2015, shortly after Apple open-sourced Swift. They modeled Kitura after Express.js, the de-facto framework for creating RESTful APIs using Node.js.</p>

<p>REST is an acronym for <em>Re</em>presentational <em>S</em>tate <em>T</em>ransfer. In RESTful apps, each unique URL represents an object. Non-unique URLs represent actions, which are combined with RESTful verbs like GET to fetch objects, POST to insert, DELETE to remove and PUT to update objects.</p>

<p>Backend development often involves many components working together. You‚Äôll only be concerned with two backend components in this Kitura tutorial: the API and database.</p>

<p>For example, if you want to populate a table view with a list of acronyms and their meanings, your client app sends a GET request to the backend. In practice, your app requests the URL <code>http://yourAPI.com/acronyms</code>.</p>

<p><a href="https://koenig-media.raywenderlich.com/uploads/2017/12/firstDiagram.png"><img src="https://koenig-media.raywenderlich.com/uploads/2017/12/firstDiagram-650x310.png" alt="Kitura tutorial client request made to API" width="650" height="310" class="aligncenter" /></a></p>

<p>The API receives your request and uses a <em>router</em> to decide how to handle it. The router checks all available <em>routes</em>, which are simply publicly accessible endpoints, to determine if there is a GET route ending in <code>/acronyms</code>. If it finds one, it executes the associated route‚Äôs code.</p>

<p>The <code class="highlighter-rouge">/acronyms</code> route then does the following:</p>

<ol>
  <li>Retrieves the acronyms from the database</li>
  <li>Serializes them into JSON</li>
  <li>Packages them into a response</li>
  <li>Returns the response to the API to send to the client</li>
</ol>

<p>This results in the following interaction between the API and database:</p>

<p><a href="https://koenig-media.raywenderlich.com/uploads/2017/12/retrievingAcronyms.png"><img src="https://koenig-media.raywenderlich.com/uploads/2017/12/retrievingAcronyms-650x310.png" alt="Kitura tutorial API and database interaction" width="650" height="310" class="aligncenter" /></a></p>

<p>If an API is RESTful, then it must also be <em>stateless</em>. In our example, you can think of the API as the orchestrator, commanding data to and fro in your ecosystem. Once the request is fulfilled, the state of the API and its routes should be unchanged and able to handle the <i>next</i> request.</p>

<p><a href="https://koenig-media.raywenderlich.com/uploads/2017/12/resolvedAcronyms.png"><img src="https://koenig-media.raywenderlich.com/uploads/2017/12/resolvedAcronyms-650x310.png" alt="Kitura tutorial API response to client" width="650" height="310" class="aligncenter" /></a></p>

<p>Just because the API is stateless doesn‚Äôt mean it isn‚Äôt allowed to store or modify objects. The API itself doesn‚Äôt store states, but it does query and update the database to fetch, store and modify objects‚Äô states.</p>

<h2 id="setting-up-the-kitura-tutorial-project">Setting up the Kitura Tutorial Project</h2>

<p>Open Terminal and enter the following commands:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">mkdir </span>KituraTIL
<span class="nb">cd </span>KituraTIL
swift package init <span class="nt">--type</span> executable
</code></pre></div></div>

<p>This uses the <a href="https://swift.org/package-manager/" target="_blank" rel="noopener">Swift Package Manager</a> to create a new executable.</p>

<p>You should see output like this:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Creating executable package: KituraTIL
Creating Package.swift
Creating README.md
Creating .gitignore
Creating Sources/
Creating Sources/KituraTIL/main.swift
Creating Tests/
</code></pre></div></div>

<p>Next, enter the following command to open <em>Package.swift</em> with Xcode:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>open <span class="nt">-a</span> Xcode Package.swift
</code></pre></div></div>

<p>Replace the entire contents of <em>Package.swift</em> with the following:</p>

<div class="language-swift highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// swift-tools-version:4.1</span>

<span class="kd">import</span> <span class="kt">PackageDescription</span>

<span class="k">let</span> <span class="nv">package</span> <span class="o">=</span> <span class="kt">Package</span><span class="p">(</span>
  <span class="c1">// 1</span>
  <span class="nv">name</span><span class="p">:</span> <span class="s">"KituraTIL"</span><span class="p">,</span>
  <span class="nv">dependencies</span><span class="p">:</span> <span class="p">[</span>
    <span class="c1">// 2</span>
    <span class="o">.</span><span class="nf">package</span><span class="p">(</span><span class="nv">url</span><span class="p">:</span> <span class="s">"https://github.com/IBM-Swift/Kitura.git"</span><span class="p">,</span>
             <span class="o">.</span><span class="nf">upToNextMinor</span><span class="p">(</span><span class="nv">from</span><span class="p">:</span> <span class="s">"2.4.1"</span><span class="p">)),</span>
    <span class="c1">// 3</span>
    <span class="o">.</span><span class="nf">package</span><span class="p">(</span><span class="nv">url</span><span class="p">:</span> <span class="s">"https://github.com/IBM-Swift/HeliumLogger.git"</span><span class="p">,</span>
             <span class="o">.</span><span class="nf">upToNextMinor</span><span class="p">(</span><span class="nv">from</span><span class="p">:</span> <span class="s">"1.7.1"</span><span class="p">)),</span>
    <span class="c1">// 4</span>
    <span class="o">.</span><span class="nf">package</span><span class="p">(</span><span class="nv">url</span><span class="p">:</span> <span class="s">"https://github.com/IBM-Swift/Kitura-CouchDB.git"</span><span class="p">,</span>
             <span class="o">.</span><span class="nf">upToNextMinor</span><span class="p">(</span><span class="nv">from</span><span class="p">:</span> <span class="s">"2.1.0"</span><span class="p">)),</span>
  <span class="p">],</span>
  <span class="c1">//5</span>
  <span class="nv">targets</span><span class="p">:</span> <span class="p">[</span>
    <span class="o">.</span><span class="nf">target</span><span class="p">(</span><span class="nv">name</span><span class="p">:</span> <span class="s">"KituraTIL"</span><span class="p">,</span>
            <span class="nv">dependencies</span><span class="p">:</span> <span class="p">[</span><span class="s">"Kitura"</span> <span class="p">,</span> <span class="s">"HeliumLogger"</span><span class="p">,</span> <span class="s">"CouchDB"</span><span class="p">],</span>
            <span class="nv">path</span><span class="p">:</span> <span class="s">"Sources"</span><span class="p">)</span>
  <span class="p">]</span>
<span class="p">)</span>
</code></pre></div></div>

<p>Here‚Äôs what each of these commands does:</p>

<ol>
  <li>You first set the name of your target executable. By convention, you should name this after the enclosing directory.</li>
  <li>Here you declare the dependency for Kitura itself.</li>
  <li>This is a backend logging framework, which you‚Äôll use to log messages while your backend app is running.</li>
  <li>You‚Äôll use this dependency to allow Kitura to communicate with CouchDB.</li>
  <li>Finally, you declare your targets and their dependencies.</li>
</ol>

<p>Save this file and go back to Terminal, where you should still be in the same directory containing <em>Package.swift</em>. Enter the following command:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>swift build
</code></pre></div></div>

<p>This will generate a lot of logging, ending with logs about compiling your Kitura tutorial project. You‚Äôll see this output at the end:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Compile Swift Module <span class="s1">'KituraTIL'</span> <span class="o">(</span>1 sources<span class="o">)</span>
Linking ./.build/x86_64-apple-macosx10.10/debug/KituraTIL
</code></pre></div></div>

<p><strong>Note:</strong> In case you get errors from <em>swift build</em>, enter the following in Terminal to verify your Swift version:&lt;/p&gt;</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>swift <span class="nt">--version</span>
</code></pre></div></div>

<p>If your version is lower than Swift 4.1, this is likely your problem. To fix this, make sure that you have the latest version of Xcode 9 installed and then run the following command:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">sudo </span>xcode-select <span class="nt">-s</span> /Applications/Xcode.app
</code></pre></div></div>

<p>...where <em>Xcode.app</em> should be replaced with whatever you called Xcode 9.</p>

<p>

If you're still having trouble, it's possible you're using <code>swiftenv</code> or another Swift version management tool, and you may need to manually set your Swift version to 4.1.</p>

<p>Here's the command to do this if you're using <code>swiftenv</code>:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>swiftenv global 4.1
</code></pre></div></div>

<h2 id="using-kitura-with-xcode">Using Kitura with Xcode</h2>

<p>Still in Terminal, at the root directory for your Kitura tutorial project, enter the following command:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>swift package generate-xcodeproj
</code></pre></div></div>

<p>You should see this output:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>generated: ./KituraTIL.xcodeproj
</code></pre></div></div>

<p>Enter this command to open your new Xcode project:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>open KituraTIL.xcodeproj/
</code></pre></div></div>

<p>You‚Äôll then be greeted with this view:</p>

<p><a href="https://koenig-media.raywenderlich.com/uploads/2018/02/Screen-Shot-2018-03-19-at-11.24.25-AM.png"><img src="https://koenig-media.raywenderlich.com/uploads/2018/02/Screen-Shot-2018-03-19-at-11.24.25-AM-650x446.png" alt="Kitura tutorial initial project" width="650" height="446" class="aligncenter size-large bordered wp-image-189218" /></a></p>

<p>From here, you need to update the <em>KituraTIL-Package</em> scheme to run your executable. Go to the top of your Xcode window, and click the scheme pane where it says <em>KituraTIL-Package</em>. You should see this dialog:</p>

<p><img src="https://koenig-media.raywenderlich.com/uploads/2018/02/Screen-Shot-2018-02-05-at-20.45.39-295x320.png" alt="Kitura tutorial edit scheme" width="295" height="320" class="aligncenter bordered" /></p>

<p>Click <em>Edit Scheme</em>, and another dialog will open. In the middle of the dialog, click the dropdown for <em>Executable</em> and select <em>KituraTIL</em>.</p>

<p><img src="https://koenig-media.raywenderlich.com/uploads/2018/02/Screen-Shot-2018-02-05-at-20.47.40-480x269.png" alt="Kitura tutorial set executable" width="480" height="269" class="bordered aligncenter" /></p>

<p>Click <em>Close</em> in the bottom-right corner of the dialog to dismiss it.</p>

<p>Next, make sure you‚Äôve set to run this scheme on <em>My Mac</em> by clicking to the right of the scheme dropdown that you clicked earlier and selecting <em>My Mac</em> from the list:</p>

<p><img src="https://koenig-media.raywenderlich.com/uploads/2018/02/Screen-Shot-2018-02-05-at-20.49.08.png" alt="Kitura tutorial select My Mac" width="426" height="64" class="bordered aligncenter" /></p>

<p>Build and run, and you‚Äôll see this printed to the console:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Hello, world!
Program ended with <span class="nb">exit </span>code: 0
</code></pre></div></div>

<p>You can safely ignore any compiler warnings about deprecations. Kitura and CouchDB use a few methods that were deprecated in Swift 4, but this shouldn‚Äôt cause any problems.</p>

<p>Awesome, you‚Äôre now ready to get your backend app up and running!</p>

<h2 id="using-kitura">Using Kitura</h2>

<p>First, create a new <em>Swift File</em> named <em>Application.swift</em> in the same directory as <em>main.swift</em>. Make sure to add this file to the <em>KituraTIL</em> executable target:</p>

<p><img src="https://koenig-media.raywenderlich.com/uploads/2018/02/Screen-Shot-2018-02-05-at-20.52.06-480x218.png" alt="Kitura tutorial set target" width="480" height="218" class="bordered aligncenter" /></p>

<p>Next, replace the contents of this file with the following:</p>

<div class="language-swift highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">import</span> <span class="kt">Kitura</span>
<span class="kd">import</span> <span class="kt">LoggerAPI</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="kt">App</span> <span class="p">{</span>
  
  <span class="c1">// 1</span>
  <span class="k">let</span> <span class="nv">router</span> <span class="o">=</span> <span class="kt">Router</span><span class="p">()</span>
  
  <span class="kd">public</span> <span class="kd">func</span> <span class="nf">run</span><span class="p">()</span> <span class="p">{</span>
    <span class="c1">// 2</span>
    <span class="kt">Kitura</span><span class="o">.</span><span class="nf">addHTTPServer</span><span class="p">(</span><span class="nv">onPort</span><span class="p">:</span> <span class="mi">8080</span><span class="p">,</span> <span class="nv">with</span><span class="p">:</span> <span class="n">router</span><span class="p">)</span>
    <span class="c1">// 3</span>
    <span class="kt">Kitura</span><span class="o">.</span><span class="nf">run</span><span class="p">()</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Here‚Äôs what this does:</p>

<ol>
  <li>The <em>Router</em> will handle incoming requests by routing them to the appropriate endpoint.</li>
  <li>Here, you register <code>router</code> to run on port 8080.</li>
  <li>Kitura will run infinitely on the main run loop after you call <code>run()</code>.</li>
</ol>

<p>With your <code>App</code> class created, open <code class="highlighter-rouge">main.swift</code> and replace its contents with the following:</p>

<div class="language-swift highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">import</span> <span class="kt">Kitura</span>
<span class="kd">import</span> <span class="kt">HeliumLogger</span>
<span class="kd">import</span> <span class="kt">LoggerAPI</span>

<span class="kt">HeliumLogger</span><span class="o">.</span><span class="nf">use</span><span class="p">()</span>

<span class="k">let</span> <span class="nv">app</span> <span class="o">=</span> <span class="kt">App</span><span class="p">()</span>
<span class="n">app</span><span class="o">.</span><span class="nf">run</span><span class="p">()</span>
</code></pre></div></div>

<p>Here you create an <code>App</code> instance and run it.</p>

<p>The <code>HeliumLogger.use()</code> command sets up <code>HeliumLogger</code> as the default logger for Kitura. It‚Äôs good practice to ‚Äúlog early and log often‚Äù.</p>

<p>Build and run, and you should see log messages from Kitura appear in the console.</p>

<p>Next, navigate to <code><a href="http://localhost:8080" rel="noopener" target="_blank">http://localhost:8080</a></code> in your browser, and you should see this page:</p>

<p><a href="https://koenig-media.raywenderlich.com/uploads/2018/03/Screen-Shot-2018-03-20-at-5.10.25-PM.png"><img src="https://koenig-media.raywenderlich.com/uploads/2018/03/Screen-Shot-2018-03-20-at-5.10.25-PM-650x460.png" alt="First Kitura server" width="650" height="460" class="aligncenter size-large bordered wp-image-189374" /></a></p>

<p>Congratulations, you‚Äôre now running a Swift RESTful API on your local machine!</p>

<h2 id="creating-your-model">Creating Your Model</h2>

<p>In this section, you‚Äôll create a model type that represents an acronym.</p>

<p>Create a new file named <em>Acronym.swift</em> and remember to add it to the <em>KituraTIL</em> target.</p>

<p>Replace the contents of this file with the following:</p>

<div class="language-swift highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// 1</span>
<span class="kd">struct</span> <span class="kt">Acronym</span><span class="p">:</span> <span class="kt">Codable</span> <span class="p">{</span>

  <span class="k">var</span> <span class="nv">id</span><span class="p">:</span> <span class="kt">String</span><span class="p">?</span>
  <span class="k">var</span> <span class="nv">short</span><span class="p">:</span> <span class="kt">String</span>
  <span class="k">var</span> <span class="nv">long</span><span class="p">:</span> <span class="kt">String</span>
  
  <span class="nf">init</span><span class="p">?(</span><span class="nv">id</span><span class="p">:</span> <span class="kt">String</span><span class="p">?,</span> <span class="nv">short</span><span class="p">:</span> <span class="kt">String</span><span class="p">,</span> <span class="nv">long</span><span class="p">:</span> <span class="kt">String</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// 2</span>
    <span class="k">if</span> <span class="n">short</span><span class="o">.</span><span class="n">isEmpty</span> <span class="o">||</span> <span class="n">long</span><span class="o">.</span><span class="n">isEmpty</span> <span class="p">{</span>
      <span class="k">return</span> <span class="kc">nil</span>
    <span class="p">}</span>
    <span class="k">self</span><span class="o">.</span><span class="n">id</span> <span class="o">=</span> <span class="n">id</span>
    <span class="k">self</span><span class="o">.</span><span class="n">short</span> <span class="o">=</span> <span class="n">short</span>
    <span class="k">self</span><span class="o">.</span><span class="n">long</span> <span class="o">=</span> <span class="n">long</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="c1">// 3</span>
<span class="kd">extension</span> <span class="kt">Acronym</span><span class="p">:</span> <span class="kt">Equatable</span> <span class="p">{</span>

  <span class="kd">public</span> <span class="kd">static</span> <span class="kd">func</span> <span class="o">==</span><span class="p">(</span><span class="nv">lhs</span><span class="p">:</span> <span class="kt">Acronym</span><span class="p">,</span> <span class="nv">rhs</span><span class="p">:</span> <span class="kt">Acronym</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kt">Bool</span> <span class="p">{</span>
    <span class="k">return</span> <span class="n">lhs</span><span class="o">.</span><span class="n">short</span> <span class="o">==</span> <span class="n">rhs</span><span class="o">.</span><span class="n">short</span> <span class="o">&amp;&amp;</span> <span class="n">lhs</span><span class="o">.</span><span class="n">long</span> <span class="o">==</span> <span class="n">rhs</span><span class="o">.</span><span class="n">long</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Here‚Äôs what this does:</p>

<ol>
  <li>By making <code>Acronym</code> conform to <code>Codable</code>, you‚Äôll be able to take advantage of a new Kitura feature named <em>Codable Routing</em>. You‚Äôll learn more about this shortly.</li>
  <li>Within the initializer, you validate that neither <code>short</code> nor <code>long</code> are empty strings.</li>
  <li>You make <code>Acronym</code> conform to <code>Equatable</code> to enable you to determine if two acronyms are the same. You‚Äôll use this later, as another form of validation.</li>
</ol>

<p>Build and run your project to make sure everything builds properly.</p>

<p><em><a href="https://developer.apple.com/documentation/swift/codable" rel="noopener" target="_blank">Codable</a></em> is simply a <code>typealias</code> that combines the <em>Encodable</em> and <em>Decodable</em> protocols. This ensures conforming objects can be converted both to and from external representations. In particular, Kitura uses this to easily convert instances to and from <em>JSON</em>.</p>

<p>Before Kitura 2.0, you had to pass a request object into every endpoint closure, parse properties manually, cast appropriately, do necessary transformations and finally create JSON to send as a response. It was a <i>lot</i> of work!</p>

<p>Fortunately, you can now leverage the power of Kitura‚Äôs <em>Codable Routing</em> to significantly reduce the boilerplate code in your routes. Win! You simply need to make your models conform to <em>Codable</em> to take advantage of this, as you did above.</p>

<p>With this theory out of the way, it‚Äôs now time to connect your API to CouchDB.</p>

<h2 id="connecting-to-couchdb">Connecting to CouchDB</h2>

<p>Open <em>Application.swift</em>, and replace its contents with the following:</p>

<div class="language-swift highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// 1</span>
<span class="kd">import</span> <span class="kt">CouchDB</span>
<span class="kd">import</span> <span class="kt">Foundation</span>
<span class="kd">import</span> <span class="kt">Kitura</span>
<span class="kd">import</span> <span class="kt">LoggerAPI</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="kt">App</span> <span class="p">{</span>

  <span class="c1">// 2</span>
  <span class="k">var</span> <span class="nv">client</span><span class="p">:</span> <span class="kt">CouchDBClient</span><span class="p">?</span>
  <span class="k">var</span> <span class="nv">database</span><span class="p">:</span> <span class="kt">Database</span><span class="p">?</span>
    
  <span class="k">let</span> <span class="nv">router</span> <span class="o">=</span> <span class="kt">Router</span><span class="p">()</span>
    
  <span class="kd">private</span> <span class="kd">func</span> <span class="nf">postInit</span><span class="p">()</span> <span class="p">{</span>
    <span class="c1">// 3</span>
  <span class="p">}</span>
    
  <span class="kd">private</span> <span class="kd">func</span> <span class="nf">createNewDatabase</span><span class="p">()</span> <span class="p">{</span>
    <span class="c1">// 4</span>
  <span class="p">}</span>
    
  <span class="kd">private</span> <span class="kd">func</span> <span class="nf">finalizeRoutes</span><span class="p">(</span><span class="n">with</span> <span class="nv">database</span><span class="p">:</span> <span class="kt">Database</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// 5</span>
  <span class="p">}</span>
    
  <span class="kd">public</span> <span class="kd">func</span> <span class="nf">run</span><span class="p">()</span> <span class="p">{</span>
    <span class="c1">// 6</span>
    <span class="nf">postInit</span><span class="p">()</span>
    <span class="kt">Kitura</span><span class="o">.</span><span class="nf">addHTTPServer</span><span class="p">(</span><span class="nv">onPort</span><span class="p">:</span> <span class="mi">8080</span><span class="p">,</span> <span class="nv">with</span><span class="p">:</span> <span class="n">router</span><span class="p">)</span>
    <span class="kt">Kitura</span><span class="o">.</span><span class="nf">run</span><span class="p">()</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Let‚Äôs go over these changes:</p>

<ol>
  <li>You first import CouchDB in order to set up your persistence layer.</li>
  <li>You add properties for <em>client</em> for CouchDB and <em>database</em> to keep track of changes.</li>
  <li>You‚Äôll add code here after you‚Äôve created your instance of <em>App</em> to connect to your database.</li>
  <li>This organizes your code stemming from the previous function.</li>
  <li>Once you‚Äôve set up your database, you‚Äôll list all available routes for your API to match against here.</li>
  <li>You call <code>postInit()</code> from within <code>run()</code> to make this part of your API setup.</li>
</ol>

<p>Next, complete <code>postInit()</code> by replacing <code>// 3</code> with the following.:</p>

<div class="language-swift highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// 1</span>
<span class="k">let</span> <span class="nv">connectionProperties</span> <span class="o">=</span> <span class="kt">ConnectionProperties</span><span class="p">(</span><span class="nv">host</span><span class="p">:</span> <span class="s">"localhost"</span><span class="p">,</span> <span class="nv">port</span><span class="p">:</span> <span class="mi">5984</span><span class="p">,</span> <span class="nv">secured</span><span class="p">:</span> <span class="kc">false</span><span class="p">)</span>
<span class="n">client</span> <span class="o">=</span> <span class="kt">CouchDBClient</span><span class="p">(</span><span class="nv">connectionProperties</span><span class="p">:</span> <span class="n">connectionProperties</span><span class="p">)</span>
<span class="c1">// 2</span>
<span class="n">client</span><span class="o">!.</span><span class="nf">dbExists</span><span class="p">(</span><span class="s">"acronyms"</span><span class="p">)</span> <span class="p">{</span> <span class="n">exists</span><span class="p">,</span> <span class="n">_</span> <span class="k">in</span>
  <span class="k">guard</span> <span class="n">exists</span> <span class="k">else</span> <span class="p">{</span>
    <span class="c1">// 3</span>
    <span class="k">self</span><span class="o">.</span><span class="nf">createNewDatabase</span><span class="p">()</span>
    <span class="k">return</span>
  <span class="p">}</span>
  <span class="c1">// 4</span>
  <span class="kt">Log</span><span class="o">.</span><span class="nf">info</span><span class="p">(</span><span class="s">"Acronyms database located - loading..."</span><span class="p">)</span>
  <span class="k">self</span><span class="o">.</span><span class="nf">finalizeRoutes</span><span class="p">(</span><span class="nv">with</span><span class="p">:</span> <span class="kt">Database</span><span class="p">(</span><span class="nv">connProperties</span><span class="p">:</span> <span class="n">connectionProperties</span><span class="p">,</span> <span class="nv">dbName</span><span class="p">:</span> <span class="s">"acronyms"</span><span class="p">))</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Here‚Äôs what you just did:</p>

<ol>
  <li>You created a <code>ConnectionProperties</code> object that you use to specify configuration values and a new <code>CouchDBClient</code>.</li>
  <li>You check to see if a matching database already exists, so you don‚Äôt overwrite existing data.</li>
  <li>If a new database does <i>not</i> exist, then you call <code>createNewDatabase()</code> to create a new database.</li>
  <li>If a new database does exist, you call <code>finalizeRoutes(with:)</code> to configure your routes.</li>
</ol>

<p>Next, complete <code>createNewDatabase()</code> by replacing <code>// 4</code> with the following:</p>

<div class="language-swift highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">Log</span><span class="o">.</span><span class="nf">info</span><span class="p">(</span><span class="s">"Database does not exist - creating new database"</span><span class="p">)</span>
<span class="c1">// 1</span>
<span class="n">client</span><span class="p">?</span><span class="o">.</span><span class="nf">createDB</span><span class="p">(</span><span class="s">"acronyms"</span><span class="p">)</span> <span class="p">{</span> <span class="n">database</span><span class="p">,</span> <span class="n">error</span> <span class="k">in</span>
  <span class="c1">// 2</span>
  <span class="k">guard</span> <span class="k">let</span> <span class="nv">database</span> <span class="o">=</span> <span class="n">database</span> <span class="k">else</span> <span class="p">{</span>
    <span class="k">let</span> <span class="nv">errorReason</span> <span class="o">=</span> <span class="kt">String</span><span class="p">(</span><span class="nv">describing</span><span class="p">:</span> <span class="n">error</span><span class="p">?</span><span class="o">.</span><span class="n">localizedDescription</span><span class="p">)</span>
    <span class="kt">Log</span><span class="o">.</span><span class="nf">error</span><span class="p">(</span><span class="s">"Could not create new database: (</span><span class="se">\(</span><span class="n">errorReason</span><span class="se">)</span><span class="s">) - acronym routes not created"</span><span class="p">)</span>
    <span class="k">return</span>
  <span class="p">}</span>
  <span class="k">self</span><span class="o">.</span><span class="nf">finalizeRoutes</span><span class="p">(</span><span class="nv">with</span><span class="p">:</span> <span class="n">database</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Here‚Äôs what this does piece by piece:</p>

<ol>
  <li>You create your database with a given name. You can choose anything, but it‚Äôs best to keep it simple.</li>
  <li>You ensure the database exists, or else, you abort and log an error.</li>
  <li>Just like before, you call <code>finalizeRoutes(with:)</code> to configure your routes</li>
</ol>

<p>You won‚Äôt be able to implement <code>finalizeRoutes</code> just yet. You first need to complete your persistence layer. That‚Äôs what you‚Äôll do in the next section.</p>

<h2 id="persisting-acronyms">Persisting Acronyms</h2>

<p>Create a file named <em>AcronymPersistence.swift</em> and add it to the <em>KituraTIL</em> target.</p>

<p>Replace the contents of <em>AcronymPersistence.swift</em> with the following:</p>

<div class="language-swift highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">import</span> <span class="kt">Foundation</span>
<span class="kd">import</span> <span class="kt">CouchDB</span>
<span class="c1">// 1</span>
<span class="kd">import</span> <span class="kt">SwiftyJSON</span>

<span class="kd">extension</span> <span class="kt">Acronym</span> <span class="p">{</span>
  <span class="c1">// 2</span>
  <span class="kd">class</span> <span class="kt">Persistence</span> <span class="p">{</span>

    <span class="kd">static</span> <span class="kd">func</span> <span class="nf">getAll</span><span class="p">(</span><span class="n">from</span> <span class="nv">database</span><span class="p">:</span> <span class="kt">Database</span><span class="p">,</span>
                       <span class="nv">callback</span><span class="p">:</span> <span class="kd">@escaping</span> <span class="p">(</span><span class="n">_</span> <span class="nv">acronyms</span><span class="p">:</span> <span class="p">[</span><span class="kt">Acronym</span><span class="p">]?,</span> <span class="n">_</span> <span class="nv">error</span><span class="p">:</span> <span class="kt">NSError</span><span class="p">?)</span> <span class="o">-&gt;</span> <span class="kt">Void</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">database</span><span class="o">.</span><span class="nf">retrieveAll</span><span class="p">(</span><span class="nv">includeDocuments</span><span class="p">:</span> <span class="kc">true</span><span class="p">)</span> <span class="p">{</span> <span class="n">documents</span><span class="p">,</span> <span class="n">error</span> <span class="k">in</span>
        <span class="k">guard</span> <span class="k">let</span> <span class="nv">documents</span> <span class="o">=</span> <span class="n">documents</span> <span class="k">else</span> <span class="p">{</span>
          <span class="nf">callback</span><span class="p">(</span><span class="kc">nil</span><span class="p">,</span> <span class="n">error</span><span class="p">)</span>
          <span class="k">return</span>
        <span class="p">}</span>
        <span class="k">var</span> <span class="nv">acronyms</span><span class="p">:</span> <span class="p">[</span><span class="kt">Acronym</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">document</span> <span class="k">in</span> <span class="n">documents</span><span class="p">[</span><span class="s">"rows"</span><span class="p">]</span><span class="o">.</span><span class="n">arrayValue</span> <span class="p">{</span>
          <span class="k">let</span> <span class="nv">id</span> <span class="o">=</span> <span class="n">document</span><span class="p">[</span><span class="s">"id"</span><span class="p">]</span><span class="o">.</span><span class="n">stringValue</span>
          <span class="k">let</span> <span class="nv">short</span> <span class="o">=</span> <span class="n">document</span><span class="p">[</span><span class="s">"doc"</span><span class="p">][</span><span class="s">"short"</span><span class="p">]</span><span class="o">.</span><span class="n">stringValue</span>
          <span class="k">let</span> <span class="nv">long</span> <span class="o">=</span> <span class="n">document</span><span class="p">[</span><span class="s">"doc"</span><span class="p">][</span><span class="s">"long"</span><span class="p">]</span><span class="o">.</span><span class="n">stringValue</span>
          <span class="k">if</span> <span class="k">let</span> <span class="nv">acronym</span> <span class="o">=</span> <span class="kt">Acronym</span><span class="p">(</span><span class="nv">id</span><span class="p">:</span> <span class="n">id</span><span class="p">,</span> <span class="nv">short</span><span class="p">:</span> <span class="n">short</span><span class="p">,</span> <span class="nv">long</span><span class="p">:</span> <span class="n">long</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">acronyms</span><span class="o">.</span><span class="nf">append</span><span class="p">(</span><span class="n">acronym</span><span class="p">)</span>
          <span class="p">}</span>
        <span class="p">}</span>
        <span class="nf">callback</span><span class="p">(</span><span class="n">acronyms</span><span class="p">,</span> <span class="kc">nil</span><span class="p">)</span>
      <span class="p">}</span>
    <span class="p">}</span>
    
    <span class="kd">static</span> <span class="kd">func</span> <span class="nf">save</span><span class="p">(</span><span class="n">_</span> <span class="nv">acronym</span><span class="p">:</span> <span class="kt">Acronym</span><span class="p">,</span> <span class="n">to</span> <span class="nv">database</span><span class="p">:</span> <span class="kt">Database</span><span class="p">,</span>
                     <span class="nv">callback</span><span class="p">:</span> <span class="kd">@escaping</span> <span class="p">(</span><span class="n">_</span> <span class="nv">id</span><span class="p">:</span> <span class="kt">String</span><span class="p">?,</span> <span class="n">_</span> <span class="nv">error</span><span class="p">:</span> <span class="kt">NSError</span><span class="p">?)</span> <span class="o">-&gt;</span> <span class="kt">Void</span><span class="p">)</span> <span class="p">{</span>
      <span class="nf">getAll</span><span class="p">(</span><span class="nv">from</span><span class="p">:</span> <span class="n">database</span><span class="p">)</span> <span class="p">{</span> <span class="n">acronyms</span><span class="p">,</span> <span class="n">error</span> <span class="k">in</span>
        <span class="k">guard</span> <span class="k">let</span> <span class="nv">acronyms</span> <span class="o">=</span> <span class="n">acronyms</span> <span class="k">else</span> <span class="p">{</span>
          <span class="k">return</span> <span class="nf">callback</span><span class="p">(</span><span class="kc">nil</span><span class="p">,</span> <span class="n">error</span><span class="p">)</span>
        <span class="p">}</span>
        <span class="c1">// 3</span>
        <span class="k">guard</span> <span class="o">!</span><span class="n">acronyms</span><span class="o">.</span><span class="nf">contains</span><span class="p">(</span><span class="n">acronym</span><span class="p">)</span> <span class="k">else</span> <span class="p">{</span>
          <span class="k">return</span> <span class="nf">callback</span><span class="p">(</span><span class="kc">nil</span><span class="p">,</span> <span class="kt">NSError</span><span class="p">(</span><span class="nv">domain</span><span class="p">:</span> <span class="s">"Kitura-TIL"</span><span class="p">,</span>
                                       <span class="nv">code</span><span class="p">:</span> <span class="mi">400</span><span class="p">,</span>
                                       <span class="nv">userInfo</span><span class="p">:</span> <span class="p">[</span><span class="s">"localizedDescription"</span><span class="p">:</span> <span class="s">"Duplicate entry"</span><span class="p">]))</span>
        <span class="p">}</span>
        <span class="n">database</span><span class="o">.</span><span class="nf">create</span><span class="p">(</span><span class="kt">JSON</span><span class="p">([</span><span class="s">"short"</span><span class="p">:</span> <span class="n">acronym</span><span class="o">.</span><span class="n">short</span><span class="p">,</span> <span class="s">"long"</span><span class="p">:</span> <span class="n">acronym</span><span class="o">.</span><span class="n">long</span><span class="p">]))</span> <span class="p">{</span> <span class="n">id</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">error</span> <span class="k">in</span>
          <span class="nf">callback</span><span class="p">(</span><span class="n">id</span><span class="p">,</span> <span class="n">error</span><span class="p">)</span>
        <span class="p">}</span>
      <span class="p">}</span>
    <span class="p">}</span>
    
    <span class="c1">// 4</span>
    <span class="kd">static</span> <span class="kd">func</span> <span class="nf">get</span><span class="p">(</span><span class="n">from</span> <span class="nv">database</span><span class="p">:</span> <span class="kt">Database</span><span class="p">,</span> <span class="n">with</span> <span class="nv">id</span><span class="p">:</span> <span class="kt">String</span><span class="p">,</span>
                    <span class="nv">callback</span><span class="p">:</span> <span class="kd">@escaping</span> <span class="p">(</span><span class="n">_</span> <span class="nv">acronym</span><span class="p">:</span> <span class="kt">Acronym</span><span class="p">?,</span> <span class="n">_</span> <span class="nv">error</span><span class="p">:</span> <span class="kt">NSError</span><span class="p">?)</span> <span class="o">-&gt;</span> <span class="kt">Void</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">database</span><span class="o">.</span><span class="nf">retrieve</span><span class="p">(</span><span class="n">id</span><span class="p">)</span> <span class="p">{</span> <span class="n">document</span><span class="p">,</span> <span class="n">error</span> <span class="k">in</span>
        <span class="k">guard</span> <span class="k">let</span> <span class="nv">document</span> <span class="o">=</span> <span class="n">document</span> <span class="k">else</span> <span class="p">{</span>
          <span class="k">return</span> <span class="nf">callback</span><span class="p">(</span><span class="kc">nil</span><span class="p">,</span> <span class="n">error</span><span class="p">)</span>
        <span class="p">}</span>
        <span class="k">guard</span> <span class="k">let</span> <span class="nv">acronym</span> <span class="o">=</span> <span class="kt">Acronym</span><span class="p">(</span><span class="nv">id</span><span class="p">:</span> <span class="n">document</span><span class="p">[</span><span class="s">"_id"</span><span class="p">]</span><span class="o">.</span><span class="n">stringValue</span><span class="p">,</span>
                                    <span class="nv">short</span><span class="p">:</span> <span class="n">document</span><span class="p">[</span><span class="s">"short"</span><span class="p">]</span><span class="o">.</span><span class="n">stringValue</span><span class="p">,</span>
                                    <span class="nv">long</span><span class="p">:</span> <span class="n">document</span><span class="p">[</span><span class="s">"long"</span><span class="p">]</span><span class="o">.</span><span class="n">stringValue</span><span class="p">)</span> <span class="k">else</span> <span class="p">{</span>
            <span class="k">return</span> <span class="nf">callback</span><span class="p">(</span><span class="kc">nil</span><span class="p">,</span> <span class="n">error</span><span class="p">)</span>
        <span class="p">}</span>
        <span class="nf">callback</span><span class="p">(</span><span class="n">acronym</span><span class="p">,</span> <span class="kc">nil</span><span class="p">)</span>
      <span class="p">}</span>
    <span class="p">}</span>
    
    <span class="kd">static</span> <span class="kd">func</span> <span class="nf">delete</span><span class="p">(</span><span class="n">with</span> <span class="nv">id</span><span class="p">:</span> <span class="kt">String</span><span class="p">,</span> <span class="n">from</span> <span class="nv">database</span><span class="p">:</span> <span class="kt">Database</span><span class="p">,</span>
                       <span class="nv">callback</span><span class="p">:</span> <span class="kd">@escaping</span> <span class="p">(</span><span class="n">_</span> <span class="nv">error</span><span class="p">:</span> <span class="kt">NSError</span><span class="p">?)</span> <span class="o">-&gt;</span> <span class="kt">Void</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">database</span><span class="o">.</span><span class="nf">retrieve</span><span class="p">(</span><span class="n">id</span><span class="p">)</span> <span class="p">{</span> <span class="n">document</span><span class="p">,</span> <span class="n">error</span> <span class="k">in</span>
        <span class="k">guard</span> <span class="k">let</span> <span class="nv">document</span> <span class="o">=</span> <span class="n">document</span> <span class="k">else</span> <span class="p">{</span>
          <span class="k">return</span> <span class="nf">callback</span><span class="p">(</span><span class="n">error</span><span class="p">)</span>
        <span class="p">}</span>
        <span class="k">let</span> <span class="nv">id</span> <span class="o">=</span> <span class="n">document</span><span class="p">[</span><span class="s">"_id"</span><span class="p">]</span><span class="o">.</span><span class="n">stringValue</span>
        <span class="c1">// 5</span>
        <span class="k">let</span> <span class="nv">revision</span> <span class="o">=</span> <span class="n">document</span><span class="p">[</span><span class="s">"_rev"</span><span class="p">]</span><span class="o">.</span><span class="n">stringValue</span>
        <span class="n">database</span><span class="o">.</span><span class="nf">delete</span><span class="p">(</span><span class="n">id</span><span class="p">,</span> <span class="nv">rev</span><span class="p">:</span> <span class="n">revision</span><span class="p">)</span> <span class="p">{</span> <span class="n">error</span> <span class="k">in</span>
          <span class="nf">callback</span><span class="p">(</span><span class="n">error</span><span class="p">)</span>
        <span class="p">}</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Here‚Äôs what this does in detail:</p>

<ol>
  <li>Kitura‚Äôs CouchDB wrapper has yet to be updated to use <code>Codable</code>, unfortunately. Instead, it utilizes <a href="https://github.com/SwiftyJSON/SwiftyJSON" rel="noopener" target="_blank">SwiftyJSON</a> to serialize objects into JSON.</li>
  <li>You create <code>Persistence</code> as a nested class within <code>Acronym</code>. This results in <code>Persistence</code>-namespaced methods for retrieving, saving and deleting <code>Acronyms</code> from CouchDB. This prevents name collisions in the event you have more than one model class, as more real-world apps do.</li>
  <li>Remember how you made <code>Acronym</code> conform to <code>Equatable</code>? This is where it comes in handy. You use it here to ensure you aren‚Äôt saving duplicate entries in the database.</li>
  <li>In addition to fetching <i>all</i> available acronyms, you also provide a method to find a single <code>Acronym</code> by matching its <code>id</code>.</li>
  <li>Here is where CouchDB differs from other NoSQL databases: each record has a revision stored as <code>_rev</code>, which you can use to check that you are making a proper update.</li>
</ol>

<h2 id="setting-up-your-codable-routes">Setting up Your Codable Routes</h2>

<p>You‚Äôre finally ready to create your routes. Create a new file named <em>AcronymRoutes.swift</em> and add it to the <em>KituraTIL</em> target.</p>

<p>Replace the contents of <em>AcronymRoutes.swift</em> with the following:</p>

<div class="language-swift highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">import</span> <span class="kt">CouchDB</span>
<span class="kd">import</span> <span class="kt">Kitura</span>
<span class="kd">import</span> <span class="kt">KituraContracts</span>
<span class="kd">import</span> <span class="kt">LoggerAPI</span>

<span class="kd">private</span> <span class="k">var</span> <span class="nv">database</span><span class="p">:</span> <span class="kt">Database</span><span class="p">?</span>

<span class="kd">func</span> <span class="nf">initializeAcronymRoutes</span><span class="p">(</span><span class="nv">app</span><span class="p">:</span> <span class="kt">App</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">database</span> <span class="o">=</span> <span class="n">app</span><span class="o">.</span><span class="n">database</span>
  <span class="c1">// 1</span>
  <span class="n">app</span><span class="o">.</span><span class="n">router</span><span class="o">.</span><span class="nf">get</span><span class="p">(</span><span class="s">"/acronyms"</span><span class="p">,</span> <span class="nv">handler</span><span class="p">:</span> <span class="n">getAcronyms</span><span class="p">)</span>
  <span class="n">app</span><span class="o">.</span><span class="n">router</span><span class="o">.</span><span class="nf">post</span><span class="p">(</span><span class="s">"/acronyms"</span><span class="p">,</span> <span class="nv">handler</span><span class="p">:</span> <span class="n">addAcronym</span><span class="p">)</span>
  <span class="n">app</span><span class="o">.</span><span class="n">router</span><span class="o">.</span><span class="nf">delete</span><span class="p">(</span><span class="s">"/acronyms"</span><span class="p">,</span> <span class="nv">handler</span><span class="p">:</span> <span class="n">deleteAcronym</span><span class="p">)</span>
<span class="p">}</span>

<span class="c1">// 2</span>
<span class="kd">private</span> <span class="kd">func</span> <span class="nf">getAcronyms</span><span class="p">(</span><span class="nv">completion</span><span class="p">:</span> <span class="kd">@escaping</span> <span class="p">([</span><span class="kt">Acronym</span><span class="p">]?,</span> <span class="kt">RequestError</span><span class="p">?)</span> <span class="o">-&gt;</span> <span class="kt">Void</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">guard</span> <span class="k">let</span> <span class="nv">database</span> <span class="o">=</span> <span class="n">database</span> <span class="k">else</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nf">completion</span><span class="p">(</span><span class="kc">nil</span><span class="p">,</span> <span class="o">.</span><span class="n">internalServerError</span><span class="p">)</span>
  <span class="p">}</span>
  <span class="kt">Acronym</span><span class="o">.</span><span class="kt">Persistence</span><span class="o">.</span><span class="nf">getAll</span><span class="p">(</span><span class="nv">from</span><span class="p">:</span> <span class="n">database</span><span class="p">)</span> <span class="p">{</span> <span class="n">acronyms</span><span class="p">,</span> <span class="n">error</span> <span class="k">in</span>
    <span class="k">return</span> <span class="nf">completion</span><span class="p">(</span><span class="n">acronyms</span><span class="p">,</span> <span class="n">error</span> <span class="k">as?</span> <span class="kt">RequestError</span><span class="p">)</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="c1">// 3</span>
<span class="kd">private</span> <span class="kd">func</span> <span class="nf">addAcronym</span><span class="p">(</span><span class="nv">acronym</span><span class="p">:</span> <span class="kt">Acronym</span><span class="p">,</span> <span class="nv">completion</span><span class="p">:</span> <span class="kd">@escaping</span> <span class="p">(</span><span class="kt">Acronym</span><span class="p">?,</span> <span class="kt">RequestError</span><span class="p">?)</span> <span class="o">-&gt;</span> <span class="kt">Void</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">guard</span> <span class="k">let</span> <span class="nv">database</span> <span class="o">=</span> <span class="n">database</span> <span class="k">else</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nf">completion</span><span class="p">(</span><span class="kc">nil</span><span class="p">,</span> <span class="o">.</span><span class="n">internalServerError</span><span class="p">)</span>
  <span class="p">}</span>
  <span class="kt">Acronym</span><span class="o">.</span><span class="kt">Persistence</span><span class="o">.</span><span class="nf">save</span><span class="p">(</span><span class="n">acronym</span><span class="p">,</span> <span class="nv">to</span><span class="p">:</span> <span class="n">database</span><span class="p">)</span> <span class="p">{</span> <span class="n">id</span><span class="p">,</span> <span class="n">error</span> <span class="k">in</span>
    <span class="k">guard</span> <span class="k">let</span> <span class="nv">id</span> <span class="o">=</span> <span class="n">id</span> <span class="k">else</span> <span class="p">{</span>
      <span class="k">return</span> <span class="nf">completion</span><span class="p">(</span><span class="kc">nil</span><span class="p">,</span> <span class="o">.</span><span class="n">notAcceptable</span><span class="p">)</span>
    <span class="p">}</span>
    <span class="kt">Acronym</span><span class="o">.</span><span class="kt">Persistence</span><span class="o">.</span><span class="nf">get</span><span class="p">(</span><span class="nv">from</span><span class="p">:</span> <span class="n">database</span><span class="p">,</span> <span class="nv">with</span><span class="p">:</span> <span class="n">id</span><span class="p">)</span> <span class="p">{</span> <span class="n">newAcronym</span><span class="p">,</span> <span class="n">error</span> <span class="k">in</span>
      <span class="k">return</span> <span class="nf">completion</span><span class="p">(</span><span class="n">newAcronym</span><span class="p">,</span> <span class="n">error</span> <span class="k">as?</span> <span class="kt">RequestError</span><span class="p">)</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="c1">// 4</span>
<span class="kd">private</span> <span class="kd">func</span> <span class="nf">deleteAcronym</span><span class="p">(</span><span class="nv">id</span><span class="p">:</span> <span class="kt">String</span><span class="p">,</span> <span class="nv">completion</span><span class="p">:</span> <span class="kd">@escaping</span> <span class="p">(</span><span class="kt">RequestError</span><span class="p">?)</span> <span class="o">-&gt;</span> <span class="kt">Void</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">guard</span> <span class="k">let</span> <span class="nv">database</span> <span class="o">=</span> <span class="n">database</span> <span class="k">else</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nf">completion</span><span class="p">(</span><span class="o">.</span><span class="n">internalServerError</span><span class="p">)</span>
  <span class="p">}</span>
  <span class="kt">Acronym</span><span class="o">.</span><span class="kt">Persistence</span><span class="o">.</span><span class="nf">delete</span><span class="p">(</span><span class="nv">with</span><span class="p">:</span> <span class="n">id</span><span class="p">,</span> <span class="nv">from</span><span class="p">:</span> <span class="n">database</span><span class="p">)</span> <span class="p">{</span> <span class="n">error</span> <span class="k">in</span>
    <span class="k">return</span> <span class="nf">completion</span><span class="p">(</span><span class="n">error</span> <span class="k">as?</span> <span class="kt">RequestError</span><span class="p">)</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Let‚Äôs look at the routes you just set up:</p>

<ol>
  <li>Here you declare <em>handlers</em> for each route, which associate API endpoints with methods to be called.</li>
  <li><code>getAcronyms</code> will be called to fetch <code>Acronyms</code> whenever a <code>GET /acronyms</code> request is made.</li>
  <li><code>addAcronym</code> will insert a new <code>Acronym</code> into the database whenever a <code>POST /acronyms</code> request is made.</li>
  <li><code>deleteAcronym</code> will remove an <code>Acronym</code> from the database whenever a <code>DELETE /acronyms</code> request is made.</li>
</ol>

<p>Notice the conciseness of each of your routes; the beauty of Kitura‚Äôs Codable Routing is that you don‚Äôt need to worry about requests or responses directly. Instead, Kitura will recognize the request that‚Äôs made, route it to the appropriate endpoint, execute just the relevant code and even create a response for you. Nice!</p>

<p>To complete your app, open <em>Application.swift</em> and complete <code>finalizeRoutes()</code> by replacing <code>// 5</code> with the following:</p>

<div class="language-swift highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">self</span><span class="o">.</span><span class="n">database</span> <span class="o">=</span> <span class="n">database</span>
<span class="nf">initializeAcronymRoutes</span><span class="p">(</span><span class="nv">app</span><span class="p">:</span> <span class="k">self</span><span class="p">)</span>
<span class="kt">Log</span><span class="o">.</span><span class="nf">info</span><span class="p">(</span><span class="s">"Acronym routes created"</span><span class="p">)</span>
</code></pre></div></div>

<h2 id="testing-your-api">Testing Your API</h2>

<p><em>Build and run</em> your Kitura tutorial project, and navigate to <a href="http://localhost:8080" rel="noopener" target="_blank">http://localhost:8080</a> to ensure your API is still running.</p>

<p>Then, open Terminal and enter the following command:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>curl http://localhost:8080/acronyms
</code></pre></div></div>

<p>If everything is set up correctly, you should get back an empty JSON placeholder (<code>[]</code>). This means you‚Äôve correctly set up your GET route!</p>

<p>Now try adding a new acronym to your backend. Type the following command in the same terminal window:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>curl <span class="nt">-X</span> POST http://localhost:8080/acronyms <span class="nt">-H</span> <span class="s1">'content-type: application/json'</span> <span class="nt">-d</span> <span class="s1">'{"short": "BRB", "long": "Be right back"}'</span>
</code></pre></div></div>

<p>Hit Enter, and you should see a response like this:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">{</span><span class="s2">"id"</span>:<span class="s2">"b2edde7b8032c30c7aeeff8d18000ad9"</span>,<span class="s2">"short"</span>:<span class="s2">"BRB"</span>,<span class="s2">"long"</span>:<span class="s2">"Be right back"</span><span class="o">}</span>
</code></pre></div></div>

<p>In Xcode, Kitura‚Äôs log messages should include a <em>Received POST type-safe request</em> message.</p>

<p>To verify this actually saved to the database, enter the following GET command one more time:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>curl http://localhost:8080/acronyms
</code></pre></div></div>

<p>If you get back the same JSON you entered inside an array, then congratulations! You‚Äôve successfully created a working API!</p>

<h2 id="where-to-go-from-here">Where to Go From Here?</h2>

<p>This tutorial has introduced you to Kitura by building a backend API. However, that is not all Kitura can do! In <a href="https://www.raywenderlich.com/181130/kitura-stencil-tutorial-how-to-make-websites-with-swift" rel="noopener" target="_blank">part two</a> of this tutorial series, you‚Äôll learn how to use Kitura and Stencil to build a website that includes a front end.</p>

<p>You can download the completed version of the project using the <em>Download Materials</em> button at the top or bottom of this tutorial.</p>

<p>As part of Kitura 2.0, The Swift@IBM team has created a command line interface for Kitura that streamlines generating a similar starter project, without requiring you to write any code yourself! You can try this out (after completing this tutorial, of course) by entering the following commands in Terminal:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>brew tap ibm-swift/kitura
brew <span class="nb">install </span>kitura
kitura init
</code></pre></div></div>

<p>If you‚Äôd like to learn more about Swift 4‚Äôs <code>Codable</code> protocol, check out our <a href="https://www.raywenderlich.com/172145/encoding-decoding-and-serialization-in-swift-4" rel="noopener" target="_blank">tutorial about it here</a>.</p>

<p>You can also read through IBM‚Äôs introduction to <a href="https://developer.ibm.com/swift/2017/10/30/codable-routing" target="_blank" rel="noopener">Kitura Codable Routing here</a>.</p>

<p>There‚Äôs a lot of material on the internet about Kitura, and some especially great stuff available directly from IBM! If you‚Äôd like to continue learning about Codable Routing and other Kitura 2.0 features, check out <a href="https://github.com/ibm/foodtrackerbackend" rel="noopener" target="_blank">this tutorial</a>.</p>

<p>I encourage you to comment in the forum below if you have any questions or comments!</p>
:ET